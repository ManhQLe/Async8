function DESC(a,b,c,e){return new N0(a,b,c,e)}function N0(a,b,c,e){this.Name=a;this.fx=b;this.Props=c;this.Async=e;this.InputCount=0;this.Params={};this.Collected=0;this.Link2=[];this.Board=null}N0.prototype.Fire=function(a,b){this.Async?this.fx.call(this,a,b,this.Board.Global,this.Board):this.fx(a,b,this.Board.Global,this.Board)};
function MA(a){this.Nodes=[];var b=this;a.forEach(function(a,e){for(var d=0;d<a.length;d+=2){var k=b.GetNode(a[d]),f=d+1;if(f<a.length){var l=a[f],f=b.GetNode(a[f+1]);f.InputCount++;k.Link2.push({Local:l,Node:f})}}});this.Leaves=this.Leafed=0;this.LastParams={};this.Nodes.forEach(function(a){a.Link2.length?1:b.Leaves++})}
MA.prototype.GetNode=function(a){var b={};switch(typeof a){case "object":b=a;break;case "function":b.Name=a.name||MA.Config.GetName();b.fx=a;break;default:b.Name=a}var c,e=this.Nodes.every(function(a,k){c=k;return a.Name!==b.Name});if(e&&!b.fx)throw"Undeclared node name: "+a;e?(b=DESC(b.Name,b.fx,b.Props,b.Async),b.Board=this,this.Nodes.push(b)):b=this.Nodes[c];return b};
MA.prototype.ExecNode=function(a,b,c){function e(b,f,c){if(f)d.Error=f,d.Endfx(null,f);else{var e=MA.FX.GetFlows(c),h,g;a.Link2.forEach(function(a){g=a.Node;h=e(g,c);0<h&&(++g.Collected,h--,a.Local?g.Params[a.Local]=b:g.Params=b);d.ExecNode(g,g.Params,h)});a.Link2.length?1:(d.LastParams[a.Name]=b,++d.Leafed==d.Leaves?(d.Leafed=0,d.Endfx(d.LastParams)):1)}}var d=this;!d.Error&&(c?c:0)+a.Collected>=a.InputCount&&(a.Collected=0,a.Fire(e,b))};
MA.prototype.Fire=function(a,b,c,e){this.Global=e;this.LastParams={};this.Endfx=c||function(){};var d=this;this.Nodes.forEach(function(c){if(b&&0<=b.indexOf(c.Name)||0==c.InputCount){var e=a.hasOwnProperty(c.Name)?a[c.Name]:{};c.Params=e;d.ExecNode(c,c.Params,c.InputCount)}})};MA.Config={i:0,GetName:function(){return"Annonymous"+this.i++}};
MA.Flows={Default:function(a,b){return 1},ChooseCurrent:function(a,b){return b.hasOwnProperty(a.Name)?b[a.Name]:0},FireBoost:function(a,b){return 0<=b.indexOf(a.Name)?a.InputCount:1}};MA.FX={GetFlows:function(a){return a?Array.isArray(a)?MA.Flows.FireBoost:a.call?a:MA.Flows.ChooseCurrent:MA.Flows.Default}};module.exports={MA:MA,DESC:DESC};
